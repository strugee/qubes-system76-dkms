%define module system76

Name:		qubes-%{module}-dkms
Version:        @VERSION@
Release:	1%{?dist}
Summary:	Qubes OS port of the System76 DKMS driver

Group:		System Environment/Kernel
License:	GPLv2
URL:		https://github.com/pop-os/system76-dkms

Requires:	dkms
Requires:       gcc, make
Requires:       kernel-devel
BuildArch:      noarch
Source0: %{name}-%{version}.tar.gz

%description
 This DKMS driver provides airplane mode, keyboard backlight, and fan support
 for System76 laptops

 Airplane mode currently does not work under Qubes.

%prep
%autosetup

%build

%install
rm -rf $RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT/usr/src/%{module}-%{version}/
cp ${RPM_BUILD_DIR}/%{name}-%{version}/*.c $RPM_BUILD_ROOT/usr/src/%{module}-%{version}
cp ${RPM_BUILD_DIR}/%{name}-%{version}/{Makefile,dkms.conf} $RPM_BUILD_ROOT/usr/src/%{module}-%{version}
cp -rf ${RPM_BUILD_DIR}/%{name}-%{version}/lib $RPM_BUILD_ROOT/
sed -i 's/__RPM_PACKAGE_VERSION__/%{version}/' $RPM_BUILD_ROOT/usr/src/%{module}-%{version}/dkms.conf

%files
%defattr(-,root,root,-)
/usr/src/%{module}-%{version}
/lib/udev/hwdb.d/99-system76-dkms.hwdb
%license LICENSE
%doc changelog.upstream
%doc README.md.upstream

%changelog
* Tue Jan 28 2020 AJ Jordan <alex@strugee.net> - 1.0.6-1
- Initial packaging for Qubes OS

%post
# Code modified from https://github.com/zfsonlinux/zfs/blob/master/rpm/generic/zfs-dkms.spec.in
POSTINST=/usr/lib/dkms/common.postinst
if [ -f $POSTINST ]; then
    $POSTINST %{module} %{version}
    exit $?
fi
echo "WARNING: $POSTINST does not exist."
echo -e "ERROR: DKMS version is too old."
exit 1

# TODO see if we need the %preun from ZFS on Linux too
